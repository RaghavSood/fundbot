<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GiveWei Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-950 text-gray-300 antialiased">

  <!-- Nav -->
  <nav class="sticky top-0 z-50 border-b border-gray-800/60 bg-gray-950/80 backdrop-blur-xl">
    <div class="mx-auto flex h-14 max-w-6xl items-center justify-between px-6">
      <a href="/" class="text-lg font-bold text-white tracking-tight">GiveWei</a>
      <div class="flex items-center gap-6 text-sm font-medium text-gray-500">
        <a href="/admin" class="text-white">Admin</a>
      </div>
    </div>
  </nav>

  <div class="mx-auto max-w-6xl px-6 py-8">
    <h1 class="text-2xl font-bold text-white mb-6">Admin Panel</h1>

    <!-- Tabs -->
    <div class="flex gap-0 border-b border-gray-800 mb-6">
      <button class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 transition text-white border-blue-500" data-tab="transactions">Transactions</button>
      <button class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 transition text-gray-500 border-transparent hover:text-gray-300" data-tab="users">Users</button>
      <button class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 transition text-gray-500 border-transparent hover:text-gray-300" data-tab="balances">Balances</button>
      <button class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 transition text-gray-500 border-transparent hover:text-gray-300" data-tab="apilogs">API Logs</button>
      <button class="tab-btn px-4 py-2.5 text-sm font-medium border-b-2 transition text-gray-500 border-transparent hover:text-gray-300" data-tab="export">Export Key</button>
    </div>

    <!-- Transactions -->
    <div class="tab-content" id="tab-transactions">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-200">Recent Transactions</h2>
        <button onclick="page=0;loadTopups()" class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 hover:bg-gray-800 transition cursor-pointer">&#x21bb; Refresh</button>
      </div>
      <div class="overflow-x-auto rounded-lg border border-gray-800">
        <table class="w-full text-left text-xs">
          <thead class="bg-gray-900/80 text-[11px] uppercase tracking-wider text-gray-500">
            <tr><th class="px-3 py-2.5">ID</th><th class="px-3 py-2.5">Provider</th><th class="px-3 py-2.5">From</th><th class="px-3 py-2.5">To</th><th class="px-3 py-2.5">Destination</th><th class="px-3 py-2.5">USD</th><th class="px-3 py-2.5">Expected</th><th class="px-3 py-2.5">Chain</th><th class="px-3 py-2.5">Tx Hash</th><th class="px-3 py-2.5">Status</th><th class="px-3 py-2.5">Time</th></tr>
          </thead>
          <tbody id="topups-body" class="divide-y divide-gray-800/60">
            <tr><td colspan="11" class="px-3 py-4 text-center text-gray-500 italic">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="flex gap-2 mt-4">
        <button id="prev-btn" disabled class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 disabled:opacity-40 hover:bg-gray-800 transition">&larr; Prev</button>
        <button id="next-btn" class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 hover:bg-gray-800 transition">Next &rarr;</button>
      </div>
    </div>

    <!-- Users -->
    <div class="tab-content hidden" id="tab-users">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-200">Users</h2>
        <button onclick="loadUsers()" class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 hover:bg-gray-800 transition cursor-pointer">&#x21bb; Refresh</button>
      </div>
      <div class="overflow-x-auto rounded-lg border border-gray-800">
        <table class="w-full text-left text-xs">
          <thead class="bg-gray-900/80 text-[11px] uppercase tracking-wider text-gray-500">
            <tr><th class="px-3 py-2.5">ID</th><th class="px-3 py-2.5">Telegram ID</th><th class="px-3 py-2.5">Username</th><th class="px-3 py-2.5">Index</th><th class="px-3 py-2.5">Address</th><th class="px-3 py-2.5">Joined</th></tr>
          </thead>
          <tbody id="users-body" class="divide-y divide-gray-800/60">
            <tr><td colspan="6" class="px-3 py-4 text-center text-gray-500 italic">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Balances -->
    <div class="tab-content hidden" id="tab-balances">
      <h2 class="text-lg font-semibold text-gray-200 mb-4">Address Balances</h2>
      <button id="refresh-balances" class="mb-4 rounded-md bg-emerald-600 px-4 py-2 text-xs font-semibold text-white hover:bg-emerald-500 transition">Refresh Balances</button>
      <div class="overflow-x-auto rounded-lg border border-gray-800">
        <table class="w-full text-left text-xs">
          <thead class="bg-gray-900/80 text-[11px] uppercase tracking-wider text-gray-500">
            <tr><th class="px-3 py-2.5">Owner</th><th class="px-3 py-2.5">Address</th><th class="px-3 py-2.5">AVAX</th><th class="px-3 py-2.5">USDC (Avax)</th><th class="px-3 py-2.5">ETH (Base)</th><th class="px-3 py-2.5">USDC (Base)</th></tr>
          </thead>
          <tbody id="balances-body" class="divide-y divide-gray-800/60">
            <tr><td colspan="6" class="px-3 py-4 text-center text-gray-500 italic">Click refresh to load balances.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- API Logs -->
    <div class="tab-content hidden" id="tab-apilogs">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-200">API Request Logs</h2>
        <button onclick="apilogPage=0;loadAPILogs()" class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 hover:bg-gray-800 transition cursor-pointer">&#x21bb; Refresh</button>
      </div>
      <div class="flex items-center gap-3 mb-4">
        <input type="text" id="apilogs-search" placeholder="Search all fields..." class="w-full max-w-md rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-200 placeholder-gray-600 focus:border-blue-500 focus:outline-none">
        <button id="apilogs-search-btn" class="rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white hover:bg-blue-500 transition whitespace-nowrap">Search</button>
      </div>
      <div id="apilogs-count" class="text-xs text-gray-500 mb-2"></div>
      <div class="overflow-x-auto rounded-lg border border-gray-800">
        <table class="w-full text-left text-xs">
          <thead class="bg-gray-900/80 text-[11px] uppercase tracking-wider text-gray-500">
            <tr><th class="px-3 py-2.5">ID</th><th class="px-3 py-2.5">Provider</th><th class="px-3 py-2.5">Method</th><th class="px-3 py-2.5">URL</th><th class="px-3 py-2.5">Status</th><th class="px-3 py-2.5">Duration</th><th class="px-3 py-2.5">Time</th><th class="px-3 py-2.5"></th></tr>
          </thead>
          <tbody id="apilogs-body" class="divide-y divide-gray-800/60">
            <tr><td colspan="8" class="px-3 py-4 text-center text-gray-500 italic">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="flex gap-2 mt-4">
        <button id="apilogs-prev" disabled class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 disabled:opacity-40 hover:bg-gray-800 transition">&larr; Prev</button>
        <button id="apilogs-next" class="rounded-md border border-gray-700 bg-gray-900 px-3 py-1.5 text-xs font-medium text-gray-400 hover:bg-gray-800 transition">Next &rarr;</button>
      </div>
    </div>

    <!-- API Log Detail Dialog -->
    <dialog id="apilog-dialog" class="bg-gray-900 text-gray-300 rounded-xl border border-gray-700 shadow-2xl p-0 w-full max-w-3xl max-h-[85vh] backdrop:bg-black/60">
      <div class="sticky top-0 flex items-center justify-between border-b border-gray-800 bg-gray-900 px-6 py-4">
        <h3 class="text-base font-semibold text-white">API Request Detail</h3>
        <button onclick="document.getElementById('apilog-dialog').close()" class="text-gray-500 hover:text-gray-300 text-lg cursor-pointer">&times;</button>
      </div>
      <div id="apilog-detail" class="p-6 overflow-y-auto space-y-4 text-xs" style="max-height: calc(85vh - 60px);"></div>
    </dialog>

    <!-- Export Key -->
    <div class="tab-content hidden" id="tab-export">
      <h2 class="text-lg font-semibold text-gray-200 mb-4">Export Private Key</h2>
      <p class="text-sm text-amber-400 mb-4">Warning: This exports the raw private key for fund recovery. Handle with extreme care.</p>
      <div class="mb-4">
        <label for="key-index" class="block text-xs font-medium text-gray-500 mb-1">Derivation Index</label>
        <input type="number" id="key-index" min="0" value="0" class="w-full max-w-xs rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-200 focus:border-blue-500 focus:outline-none">
      </div>
      <button id="export-btn" class="rounded-md bg-red-600 px-4 py-2 text-xs font-semibold text-white hover:bg-red-500 transition">Export Key</button>
      <div id="key-result" class="hidden mt-4 rounded-lg border border-gray-800 bg-gray-900 p-4 text-sm break-all">
        <div class="text-amber-400 text-xs mb-2">Keep this private key safe. Do not share it.</div>
        <p><span class="font-medium text-gray-400">Index:</span> <span id="res-index" class="text-white"></span></p>
        <p class="mt-1"><span class="font-medium text-gray-400">Address:</span> <code id="res-address" class="text-blue-400"></code></p>
        <p class="mt-1"><span class="font-medium text-gray-400">Private Key:</span> <code id="res-key" class="text-red-400"></code></p>
      </div>
    </div>
  </div>

  <script>
    function truncAddr(addr) {
      if (!addr || addr.length <= 14) return addr || '';
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }
    function truncTx(hash) {
      if (!hash || hash.length <= 16) return hash || '';
      return hash.slice(0, 8) + '...' + hash.slice(-6);
    }
    let explorers = {};
    fetch('/api/explorers').then(r => r.json()).then(d => { explorers = d || {}; });
    function explorerTxURL(chain, hash) {
      const base = explorers[chain];
      return base ? `${base}/tx/${hash}` : null;
    }
    function addrCell(text) {
      if (!text) return '';
      return `<span class="inline-flex items-center gap-1 whitespace-nowrap" title="${text}"><code class="rounded bg-gray-800 px-1.5 py-0.5 text-[11px]">${truncAddr(text)}</code><button onclick="navigator.clipboard.writeText('${text}')" title="Copy" class="text-gray-600 hover:text-gray-300 text-[10px] cursor-pointer">&#x2398;</button></span>`;
    }
    function txCell(text, chain) {
      if (!text) return '';
      const url = explorerTxURL(chain, text);
      const display = url ? `<a href="${url}" target="_blank" class="text-blue-400 hover:underline">${truncTx(text)}</a>` : truncTx(text);
      return `<span class="inline-flex items-center gap-1 whitespace-nowrap" title="${text}"><code class="rounded bg-gray-800 px-1.5 py-0.5 text-[11px]">${display}</code><button onclick="navigator.clipboard.writeText('${text}')" title="Copy" class="text-gray-600 hover:text-gray-300 text-[10px] cursor-pointer">&#x2398;</button></span>`;
    }
    function statusBadge(status) {
      const colors = { pending: 'text-amber-400', completed: 'text-emerald-400', success: 'text-emerald-400', failed: 'text-red-400' };
      return `<span class="${colors[status] || 'text-gray-400'}">${status}</span>`;
    }

    // Tab switching with hash persistence
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-white', 'border-blue-500'); b.classList.add('text-gray-500', 'border-transparent'); });
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if (!btn) return;
      btn.classList.remove('text-gray-500', 'border-transparent');
      btn.classList.add('text-white', 'border-blue-500');
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      location.hash = tabName;
    }
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Transactions
    let page = 0;
    const pageSize = 50;
    function loadTopups() {
      fetch(`/api/admin/topups?limit=${pageSize}&offset=${page * pageSize}`)
        .then(r => r.json())
        .then(rows => {
          const body = document.getElementById('topups-body');
          if (!rows || rows.length === 0) {
            body.innerHTML = '<tr><td colspan="11" class="px-3 py-4 text-center text-gray-500">No transactions found.</td></tr>';
            return;
          }
          body.innerHTML = rows.map(r => `<tr class="hover:bg-gray-900/50">
            <td class="px-3 py-2"><code class="rounded bg-gray-800 px-1.5 py-0.5 text-[11px]">${r.ShortID}</code></td>
            <td class="px-3 py-2">${r.Provider}</td>
            <td class="px-3 py-2">${r.FromAsset || ''}</td>
            <td class="px-3 py-2">${r.ToAsset || ''}</td>
            <td class="px-3 py-2">${addrCell(r.Destination)}</td>
            <td class="px-3 py-2 font-mono">$${Number(r.InputAmountUsd || 0).toFixed(2)}</td>
            <td class="px-3 py-2">${r.ExpectedOutput || ''}</td>
            <td class="px-3 py-2">${r.FromChain}</td>
            <td class="px-3 py-2">${txCell(r.TxHash, r.FromChain)}</td>
            <td class="px-3 py-2">${statusBadge(r.Status)}</td>
            <td class="px-3 py-2 text-gray-500">${new Date(r.CreatedAt).toLocaleString()}</td>
          </tr>`).join('');
          document.getElementById('prev-btn').disabled = page === 0;
          document.getElementById('next-btn').disabled = rows.length < pageSize;
        });
    }
    document.getElementById('prev-btn').addEventListener('click', () => { page--; loadTopups(); });
    document.getElementById('next-btn').addEventListener('click', () => { page++; loadTopups(); });
    loadTopups();

    // Users
    function loadUsers() {
      const body = document.getElementById('users-body');
      body.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500 italic">Loading...</td></tr>';
      fetch('/api/admin/users')
        .then(r => r.json())
        .then(users => {
          if (!users || users.length === 0) {
            body.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No users found.</td></tr>';
            return;
          }
          body.innerHTML = users.map(u => `<tr class="hover:bg-gray-900/50">
            <td class="px-3 py-2">${u.ID}</td>
            <td class="px-3 py-2">${u.TelegramID}</td>
            <td class="px-3 py-2">${u.Username || '-'}</td>
            <td class="px-3 py-2">${u.index}</td>
            <td class="px-3 py-2">${addrCell(u.address)}</td>
            <td class="px-3 py-2 text-gray-500">${new Date(u.CreatedAt).toLocaleString()}</td>
          </tr>`).join('');
        });
    }
    loadUsers();

    // Balances
    document.getElementById('refresh-balances').addEventListener('click', () => {
      const body = document.getElementById('balances-body');
      body.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500 italic">Loading balances...</td></tr>';
      fetch('/api/admin/balances')
        .then(r => r.json())
        .then(bals => {
          if (!bals || bals.length === 0) {
            body.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No balances found.</td></tr>';
            return;
          }
          body.innerHTML = bals.map(b => `<tr class="hover:bg-gray-900/50">
              <td class="px-3 py-2 text-white">${escapeHtml(b.owner)}</td>
              <td class="px-3 py-2">${addrCell(b.address)}</td>
              <td class="px-3 py-2 font-mono">${formatWei(b.avax_native, 'avalanche')}</td>
              <td class="px-3 py-2 font-mono">${formatUSDC(b.avax_usdc)} USDC</td>
              <td class="px-3 py-2 font-mono">${formatWei(b.base_native, 'base')}</td>
              <td class="px-3 py-2 font-mono">${formatUSDC(b.base_usdc)} USDC</td>
            </tr>`).join('');
        });
    });

    function formatWei(wei, chain) {
      const val = BigInt(wei);
      const whole = val / BigInt(1e18);
      const frac = val % BigInt(1e18);
      const fracStr = frac.toString().padStart(18, '0').slice(0, 6);
      const symbol = chain === 'avalanche' ? 'AVAX' : chain === 'base' ? 'ETH' : chain.toUpperCase();
      return `${whole}.${fracStr} ${symbol}`;
    }

    function formatUSDC(raw) {
      const val = BigInt(raw);
      const whole = val / BigInt(1e6);
      const frac = (val % BigInt(1e6)).toString().padStart(6, '0').slice(0, 2);
      return `${whole}.${frac}`;
    }

    // API Logs
    let apilogPage = 0;
    const apilogPageSize = 50;
    let apilogSearch = '';

    function loadAPILogs() {
      const q = encodeURIComponent(apilogSearch);
      fetch(`/api/admin/api-logs?limit=${apilogPageSize}&offset=${apilogPage * apilogPageSize}&q=${q}`)
        .then(r => r.json())
        .then(data => {
          const body = document.getElementById('apilogs-body');
          const rows = data.rows || [];
          const total = data.total || 0;
          document.getElementById('apilogs-count').textContent = total > 0 ? `${total} result${total !== 1 ? 's' : ''}` : '';
          if (rows.length === 0) {
            body.innerHTML = '<tr><td colspan="8" class="px-3 py-4 text-center text-gray-500">No API logs found.</td></tr>';
            return;
          }
          body.innerHTML = rows.map(r => {
            const statusColor = r.ResponseStatus && r.ResponseStatus.Valid
              ? (r.ResponseStatus.Int64 >= 400 ? 'text-red-400' : r.ResponseStatus.Int64 >= 300 ? 'text-amber-400' : 'text-emerald-400')
              : 'text-gray-500';
            const statusText = r.ResponseStatus && r.ResponseStatus.Valid ? r.ResponseStatus.Int64 : '-';
            const durationText = r.DurationMs && r.DurationMs.Valid ? r.DurationMs.Int64 + 'ms' : '-';
            const truncUrl = r.Url.length > 60 ? r.Url.slice(0, 60) + '...' : r.Url;
            const hasError = r.Error && r.Error.Valid && r.Error.String;
            return `<tr class="hover:bg-gray-900/50">
              <td class="px-3 py-2 text-gray-500">${r.ID}</td>
              <td class="px-3 py-2"><span class="rounded bg-gray-800 px-1.5 py-0.5 text-[11px]">${r.Provider}</span></td>
              <td class="px-3 py-2 font-mono">${r.Method}</td>
              <td class="px-3 py-2 max-w-xs truncate" title="${r.Url}">${truncUrl}</td>
              <td class="px-3 py-2 font-mono ${statusColor}">${statusText}${hasError ? ' <span class="text-red-400">ERR</span>' : ''}</td>
              <td class="px-3 py-2 text-gray-500">${durationText}</td>
              <td class="px-3 py-2 text-gray-500">${new Date(r.CreatedAt).toLocaleString()}</td>
              <td class="px-3 py-2"><button onclick="showAPILogDetail(${r.ID})" class="text-blue-400 hover:underline cursor-pointer">Details</button></td>
            </tr>`;
          }).join('');
          document.getElementById('apilogs-prev').disabled = apilogPage === 0;
          document.getElementById('apilogs-next').disabled = rows.length < apilogPageSize;
        });
    }

    document.getElementById('apilogs-search-btn').addEventListener('click', () => {
      apilogSearch = document.getElementById('apilogs-search').value.trim();
      apilogPage = 0;
      loadAPILogs();
    });
    document.getElementById('apilogs-search').addEventListener('keydown', e => {
      if (e.key === 'Enter') { apilogSearch = e.target.value.trim(); apilogPage = 0; loadAPILogs(); }
    });
    document.getElementById('apilogs-prev').addEventListener('click', () => { apilogPage--; loadAPILogs(); });
    document.getElementById('apilogs-next').addEventListener('click', () => { apilogPage++; loadAPILogs(); });
    let apilogsLoaded = false;
    document.querySelector('[data-tab="apilogs"]').addEventListener('click', () => { if (!apilogsLoaded) { apilogsLoaded = true; loadAPILogs(); } });

    // Restore tab from hash
    const validTabs = ['transactions', 'users', 'balances', 'apilogs', 'export'];
    const hashTab = location.hash.replace('#', '');
    if (validTabs.includes(hashTab)) {
      switchTab(hashTab);
      if (hashTab === 'apilogs' && !apilogsLoaded) { apilogsLoaded = true; loadAPILogs(); }
    }
    window.addEventListener('hashchange', () => {
      const t = location.hash.replace('#', '');
      if (validTabs.includes(t)) {
        switchTab(t);
        if (t === 'apilogs' && !apilogsLoaded) { apilogsLoaded = true; loadAPILogs(); }
      }
    });

    function showAPILogDetail(id) {
      fetch(`/api/admin/api-log/${id}`)
        .then(r => r.json())
        .then(d => {
          const detail = document.getElementById('apilog-detail');
          const ns = v => (v && v.Valid) ? v.String : '';
          const ni = v => (v && v.Valid) ? v.Int64 : '';
          const fmtBody = s => {
            if (!s) return '<span class="text-gray-600 italic">empty</span>';
            try { return '<pre class="whitespace-pre-wrap break-all bg-gray-950 rounded-lg p-3 border border-gray-800 overflow-x-auto">' + JSON.stringify(JSON.parse(s), null, 2) + '</pre>'; }
            catch { return '<pre class="whitespace-pre-wrap break-all bg-gray-950 rounded-lg p-3 border border-gray-800 overflow-x-auto">' + escapeHtml(s) + '</pre>'; }
          };
          const fmtHeaders = s => {
            if (!s) return '<span class="text-gray-600 italic">none</span>';
            return '<pre class="whitespace-pre-wrap break-all bg-gray-950 rounded-lg p-3 border border-gray-800 overflow-x-auto">' + escapeHtml(s) + '</pre>';
          };
          const statusCode = ni(d.ResponseStatus);
          const statusColor = statusCode >= 400 ? 'text-red-400' : statusCode >= 300 ? 'text-amber-400' : 'text-emerald-400';
          const errorSection = ns(d.Error) ? `<div><h4 class="text-[11px] uppercase tracking-wider text-red-400 mb-1">Error</h4><pre class="whitespace-pre-wrap break-all bg-red-950/30 text-red-300 rounded-lg p-3 border border-red-900/40">${escapeHtml(ns(d.Error))}</pre></div>` : '';

          detail.innerHTML = `
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-gray-500">Provider</span><div class="text-white mt-0.5">${d.Provider}</div></div>
              <div><span class="text-gray-500">Method</span><div class="text-white mt-0.5 font-mono">${d.Method}</div></div>
              <div class="col-span-2"><span class="text-gray-500">URL</span><div class="text-blue-400 mt-0.5 break-all">${d.Url}</div></div>
              <div><span class="text-gray-500">Status</span><div class="mt-0.5 font-mono ${statusColor}">${statusCode || '-'}</div></div>
              <div><span class="text-gray-500">Duration</span><div class="text-white mt-0.5">${ni(d.DurationMs) !== '' ? ni(d.DurationMs) + 'ms' : '-'}</div></div>
              <div class="col-span-2"><span class="text-gray-500">Timestamp</span><div class="text-white mt-0.5">${new Date(d.CreatedAt).toLocaleString()}</div></div>
            </div>
            ${errorSection}
            <div><h4 class="text-[11px] uppercase tracking-wider text-gray-500 mb-1">Request Headers</h4>${fmtHeaders(ns(d.RequestHeaders))}</div>
            <div><h4 class="text-[11px] uppercase tracking-wider text-gray-500 mb-1">Request Body</h4>${fmtBody(ns(d.RequestBody))}</div>
            <div><h4 class="text-[11px] uppercase tracking-wider text-gray-500 mb-1">Response Headers</h4>${fmtHeaders(ns(d.ResponseHeaders))}</div>
            <div><h4 class="text-[11px] uppercase tracking-wider text-gray-500 mb-1">Response Body</h4>${fmtBody(ns(d.ResponseBody))}</div>
          `;
          document.getElementById('apilog-dialog').showModal();
        })
        .catch(e => alert('Error loading detail: ' + e));
    }

    function escapeHtml(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // Export Key
    document.getElementById('export-btn').addEventListener('click', () => {
      const idx = parseInt(document.getElementById('key-index').value, 10);
      if (isNaN(idx) || idx < 0) return alert('Invalid index');
      if (!confirm(`Are you sure you want to export the private key for index ${idx}? This is a sensitive operation.`)) return;

      fetch('/api/admin/export-key', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx })
      })
        .then(r => r.json())
        .then(d => {
          document.getElementById('key-result').classList.remove('hidden');
          document.getElementById('res-index').textContent = d.index;
          document.getElementById('res-address').textContent = d.address;
          document.getElementById('res-key').textContent = d.private_key;
        })
        .catch(e => alert('Error: ' + e));
    });
  </script>
</body>
</html>
